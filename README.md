# makefiles repo

This package provides supporting glue for cross-platform Makefiles using
GNU make.

## Overview

Plenty of tools exist to add sanity as a layer atop Makefiles, generating
makefiles at runtime for a specific target, etc., but make itself is plenty
featureful.

Harnessing the power of make, we get:

* Dependency tracking for minimul rebuild
* Parallel builds via `make -j`
* Some scripting, useful for platform-specific configuration (who needs `./configure`?).

The philosophy of the makefiles was inspired by the [recursive make considered
harmful paper][1].  A library using these makefiles authors its own
`Makefile.inc` defining variables and targets to be consumed by the parent.
Thus we simulate "recursive" makefiles via inclusion of the `Makefile.inc`
files.

## `make depend` and per-project `CFLAGS`

In the `scripts` directory is a simple script that parses files looking for
`#include` directives, generating dependency rules to be consumed by make.

Example usage (a `make depend` target in a Makefile):

    export
    depend:
    	env PROJECT=LIBFOO $(DEPEND) src/*.c src/*.cc src/*.m > depend.mk

Then in `Makefile.inc`:

    # include "depend.mk" if it exists
    -include $(LIBFOO_ROOT)depend.mk

`make depend` will generate rules such as:

    # This file was generated by "make depend".
    #

    $(LIBFOO_ROOT)src/foo.o: $(LIBFOO_ROOT)src/foo.c $(LIBFOO_ROOT)include/foo/bar.h
    	$(CC) $(CFLAGS) $(LIBFOO_CFLAGS) -c -o $@ $<

This allows make to not only correctly calculate header dependencies for
`src/foo.o`, but also allows us to set per-library `CFLAGS` via `LIBFOO_CFLAGS`.

## Notes for building on Windows

Windows builds work inside `cmd.exe`.  It is assumed that [MSysGit binaries][2]
a [Win32 port of GNU make][3], and [nasm][4] are on the PATH.

C and C++ compilation happen via [clwrapper][5], included with the repo.  It
has been tested with VS2015 and Windows SDK 10586.  VS and Windows SDK are a
bit of a moving target so I make no guarantees about more recent builds.

By default, x86 and WinXP support are assumed.  Try "make WIN64=y" to build
for amd64.

## Simple continuous integration builds

`scripts/remote-build.sh` will take a tarball of the repo, push it to hosts
over `ssh`, and running `make -j` for parallel builds on the remote host.

The server piece of this also works with the MS port of sshd for Windows 10.

First, we assume that the remote host recognizes your SSH key and you can
authenticate with it using the username `user`.  These instructions are beyond
the scope of this writing.

On the remote host we set up a [hacky host discovery method][6]:

    perl scripts/bcast.pl -d -n myhost

You can verify this works with a client:

    $ perl scripts/bcast.pl -n myhost
    [ip address should appear]
    $ ssh user@`perl scripts/bcast.pl -n myhost`
    [make sure your config works so you can get a shell this way]

When you're ready to build:

    $ sh scripts/remote-build.sh myhost

This will copy resulting binaries into `./out/`.

Note that you can specify multiple hosts on the command line, and the script
will run the necessary ssh commands in parallel. 

[1]: https://aegis.sourceforge.net/auug97.pdf
[2]: https://gitforwindows.org/
[3]: http://gnuwin32.sourceforge.net/packages/make.htm
[4]: https://www.nasm.us/
[5]: https://github.com/asveikau/clwrapper
[6]: https://github.com/asveikau/bcast
